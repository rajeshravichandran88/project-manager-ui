<!DOCTYPE html>
<html ng-app="spaApp">
<head>
    <link href="style.css" rel="stylesheet">
    <script src="angular.min.js"></script>
	<script src="angular-route.min.js"></script>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>
	<title>Project Manager</title>
</head>
<body>
	<h1 align="center">Project Manager</h1>
	<br>
	<ul class="nav nav-tabs" style="width:100%">
	  <li id="liProject" class="active"><a href="#/project">Add Project</a></li>
	  <li id="liAddTask"><a href="#/addtask">Add Task</a></li>
	  <li id="liUser"><a href="#/user">Add User</a></li>
	  <li id="liViewTask"><a href="#/viewtask">View Task</a></li>
	</ul>
	<div ng-view align="center"></div>

<script>
angular.module("spaApp", ["ngRoute"])
.config(function($routeProvider){
	$routeProvider
	.when("/project", {
		templateUrl: "pages/project.html",
		controller: "projectController"
	})
	.when("/addtask", {
		templateUrl: "pages/addtask.html",
		controller: "addTaskController"
	})
	.when("/user", {
		templateUrl: "pages/user.html",
		controller: "userController"
	})
	.when("/viewtask", {
		templateUrl: "pages/viewtask.html",
		controller: "viewTaskController"
	})
}).controller("projectController", function($scope, $http) {
	
  console.log("project");
  var projectElem = angular.element( document.querySelector( '#liProject' ) );
  var addTaskElem = angular.element( document.querySelector( '#liAddTask' ) );
  var userElem = angular.element( document.querySelector( '#liUser' ) );
  var viewTaskElem = angular.element( document.querySelector( '#liViewTask' ) );
  projectElem.addClass('active');
  addTaskElem.removeClass('active');
  userElem.removeClass('active');
  viewTaskElem.removeClass('active');
  $scope.projects = {};
  $scope.users = {};
  $scope.dateFlag = false;
  
  $scope.loadProjects = function () {
	  $http.get("http://localhost:9000/projectmanager/project/")
	  .then(function(response) {
		  for(i=0; i<response.data.length; i++) {
			  var project = response.data[i];
			  var completedCount = 0;
			  for(j=0; j<project.tasks.length; j++) {
				  if(project.tasks[j].status.includes("completed")) {
					  completedCount++;
				  }
			  }
			  project.completed = completedCount;
		  }
	      $scope.projects = response.data;
	  });
	  
	  $scope.reset();
  }
  
  $scope.searchManager = function () {
	  $http.get("http://localhost:9000/projectmanager/user/")
	  .then(function(response) {
	    $scope.users = response.data;
	  });
	  
  }
  
  $scope.setSelected = function (user) {
	  $scope.selectedUser = user;
  }
  
  $scope.selectUser = function () {
	  $scope.manager = $scope.selectedUser.firstName + " " + $scope.selectedUser.lastName;
  }
  
  $scope.toggleDateFlag = function () {
	  if($scope.dateFlag == true) {
		  $scope.dateFlag = false;
	  } else {
		  $scope.dateFlag = true;
	  }	  
  }
  
  $scope.reset = function () {
	  $scope.selectedUser = undefined;
	  $scope.manager = undefined;
	  $scope.projectName = undefined;
	  $scope.startDate = undefined;
	  $scope.endDate = undefined;
	  $scope.priority = 0;
	  $scope.dateFlag = false;
	  $scope.selectedUser = undefined;
	  angular.element(document.querySelector('#rangeSlider')).value = 0;
  }
  
  $scope.sortByCompleted = function () {
	  $scope.projects.sort(function(a, b){
		  return b.completed - a.completed;
		});
  }
  
  $scope.sortByStartDate = function () {
	  $scope.projects.sort(function(a, b){
		  return new Date(a.formattedStartDate).getTime() - new Date(b.formattedStartDate).getTime();
		});
  }
  
  $scope.sortByEndDate = function () {
	  $scope.projects.sort(function(a, b){
		  return new Date(a.formattedEndDate).getTime() - new Date(b.formattedEndDate).getTime();
		});
  }
  
  $scope.sortByPriority = function () {
	  $scope.projects.sort(function(a, b){
		  return a.priority - b.priority;
		});
  }
  
  $scope.filterProjects = function () {
	  console.log($scope.searchTxt);
	  if($scope.searchTxt == '') {
		  $scope.loadProjects();
	  } else {
		  $scope.projects = $scope.projects.filter(function (el) {
			  return el.project.includes($scope.searchTxt);
			});
	  }
  }
  
  $scope.addNewProject = function () {
	  var valid = true;
	  if($scope.projectName == undefined || $scope.projectName == '') {
		  valid = false;
	  }
	  
	  if($scope.startDate == undefined || $scope.startDate == '') {
		  valid = false;
	  }
	  
	  if($scope.endDate == undefined || $scope.endDate == '') {
		  valid = false;
	  }
	  
	  if($scope.priority == undefined || $scope.priority == '') {
		  valid = false;
	  }
	  
	  if(valid) {
		  var projectJson = {};
		  projectJson.project = $scope.projectName;
		  projectJson.startDate = $scope.startDate;
		  projectJson.endDate = $scope.endDate;
		  projectJson.priority = $scope.priority;
		  
		  $http.post("http://localhost:9000/projectmanager/project/add", projectJson)
		  .then(function(response) {
			  console.log(response);
		    if(response.data) {
		    	if(response.data.status) {
		    		alert("Project Successfully Saved");
		    		$scope.reset();
		    		$scope.loadProjects();
		    	} else {
		    		alert("Project Not Saved");
		    	}
		    }
		  });
	  } else {
		  alert("All fields are Mandatory");
	  }
  }
  
  $scope.editProject = function (projectData) {
	  $scope.projectName = projectData.project;
	  $scope.startDate = projectData.formattedStartDate;
	  $scope.endDate = projectData.formattedEndDate;
	  $scope.priority = projectData.priority;
	  $scope.selectedUser = projectData.user;
	  $scope.manager = $scope.selectedUser.firstName + " " + $scope.selectedUser.lastName;
	  angular.element(document.querySelector('#rangeSlider')).value = $scope.priority;
	  angular.element(document.querySelector('#sliderValue')).value = $scope.priority;
	  $scope.dateFlag = true;
  }
  
}).controller("addTaskController", function($scope) {
	
  console.log("task");
  var projectElem = angular.element( document.querySelector( '#liProject' ) );
  var addTaskElem = angular.element( document.querySelector( '#liAddTask' ) );
  var userElem = angular.element( document.querySelector( '#liUser' ) );
  var viewTaskElem = angular.element( document.querySelector( '#liViewTask' ) );
  addTaskElem.addClass('active');
  projectElem.removeClass('active');
  userElem.removeClass('active');
  viewTaskElem.removeClass('active');
  
  
}).controller("userController", function($scope) {
	
  console.log("user");
  var projectElem = angular.element( document.querySelector( '#liProject' ) );
  var addTaskElem = angular.element( document.querySelector( '#liAddTask' ) );
  var userElem = angular.element( document.querySelector( '#liUser' ) );
  var viewTaskElem = angular.element( document.querySelector( '#liViewTask' ) );
  userElem.addClass('active');
  addTaskElem.removeClass('active');
  projectElem.removeClass('active');
  viewTaskElem.removeClass('active');
  
}).controller("viewTaskController", function($scope) {
	
  console.log("task");
  var projectElem = angular.element( document.querySelector( '#liProject' ) );
  var addTaskElem = angular.element( document.querySelector( '#liAddTask' ) );
  var userElem = angular.element( document.querySelector( '#liUser' ) );
  var viewTaskElem = angular.element( document.querySelector( '#liViewTask' ) );
  viewTaskElem.addClass('active');
  addTaskElem.removeClass('active');
  userElem.removeClass('active');
  projectElem.removeClass('active');
	  
});
</script>

 
</body>
</html>